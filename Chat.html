<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat</title>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <link rel="stylesheet" href="CSS/Chat.css">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
    <script>
    // import data from './gg.json' assert { type: 'json' };
    // data.frist="gggggg";
    // console.log(data);
    
  
    </script>
    <script>
        const firebaseConfig = {
        apiKey: "AIzaSyA_C2H-nMgddaJk-fJ1VAWEOtRWero9Hzs",
        authDomain: "graphite-bay-370409.firebaseapp.com",
        databaseURL: "https://graphite-bay-370409-default-rtdb.firebaseio.com",
        projectId: "graphite-bay-370409",
        storageBucket: "graphite-bay-370409.appspot.com",
        messagingSenderId: "584286098040",
        appId: "1:584286098040:web:820b387e23b8503706538d",
        measurementId: "G-HZT3MGGC9E"
    };
    
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);

    var UserName = localStorage.getItem("User_Name");

    if(UserName==null){
      window.location.replace('Home.html');
    }
    // console.log(UserName);

    var myName = UserName;    //prompt("Enter your name");
    function sendMessage() {
      // Msg 33 charecter Funtion
      var x = document.getElementById("message").value;
        if(x.length<=33){
            // var v = ""
            // v +=`${x}` ;
            localStorage.setItem("User_Msg",x);
            
        }else if(x.length>33 && x.length<=66){
            var s1 = x.substr(0,33);
            var s2 = x.substr(33,(x.length));
            var v = ""
            v +=`${s1}<br>${s2}` ;
            localStorage.removeItem("User_Msg");
            localStorage.setItem("User_Msg",v);
        }
        else if(x.length>66 && x.length<=99){
            var s1 = x.substr(0,33);
            var s2 = x.substr(33,33);
            var s3 = x.substr(66,x.length);
            var v = ""
            v +=`${s1}<br>${s2}<br>${s3}` ;
            localStorage.removeItem("User_Msg");
            localStorage.setItem("User_Msg",v);
        }else if(x.length>99 && x.length<=132){
            var s1 = x.substr(0,33);
            var s2 = x.substr(33,33);
            var s3 = x.substr(66,33);
            var s4 = x.substr(99,x.length);
            var v = ""
            v +=`${s1}<br>${s2}<br>${s3}<br>${s4}` ;
            localStorage.removeItem("User_Msg");
            localStorage.setItem("User_Msg",v);
        }else if(x.length>132 && x.length<=165){
            var s1 = x.substr(0,33);
            var s2 = x.substr(33,33);
            var s3 = x.substr(66,33);
            var s4 = x.substr(99,33);
            var s5 = x.substr(132,x.length);
            var v = ""
            v +=`${s1}<br>${s2}<br>${s3}<br>${s4}<br>${s5}` ;
            localStorage.removeItem("User_Msg");
            localStorage.setItem("User_Msg",v);
        }else if(x.length>165 && x.length<=198){
            var s1 = x.substr(0,33);
            var s2 = x.substr(33,33);
            var s3 = x.substr(66,33);
            var s4 = x.substr(99,33);
            var s5 = x.substr(132,33);
            var s6 = x.substr(165,x.length);
            var v = ""
            v +=`${s1}<br>${s2}<br>${s3}<br>${s4}<br>${s5}<br>${s6}` ;
            localStorage.removeItem("User_Msg");
            localStorage.setItem("User_Msg",v);
        }else if(x.length>198 && x.length<=231){
            var s1 = x.substr(0,33);
            var s2 = x.substr(33,33);
            var s3 = x.substr(66,33);
            var s4 = x.substr(99,33);
            var s5 = x.substr(132,33);
            var s6 = x.substr(165,33);
            var s7 = x.substr(198,x.length);
            var v = ""
            v +=`${s1}<br>${s2}<br>${s3}<br>${s4}<br>${s5}<br>${s6}<br>${s7}` ;
            localStorage.removeItem("User_Msg");
            localStorage.setItem("User_Msg",v);
        }else if(x.length>198 && x.length<=231){
            var s1 = x.substr(0,33);
            var s2 = x.substr(33,33);
            var s3 = x.substr(66,33);
            var s4 = x.substr(99,33);
            var s5 = x.substr(132,33);
            var s6 = x.substr(165,33);
            var s7 = x.substr(198,33);
            var s8 = x.substr(231,x.length);
            var v = ""
            v +=`${s1}<br>${s2}<br>${s3}<br>${s4}<br>${s5}<br>${s6}<br>${s7}<br>${s8}` ;
            localStorage.removeItem("User_Msg");
            localStorage.setItem("User_Msg",v);
        }else{
            var s1 = x.substr(0,33);
            var s2 = x.substr(33,33);
            var s3 = x.substr(66,33);
            var s4 = x.substr(99,33);
            var s5 = x.substr(132,33);
            var s6 = x.substr(165,33);
            var s7 = x.substr(198,33);
            var s8 = x.substr(231,33);
            var s9 = x.substr(231,x.length);
            var v = ""
            v +=`${s1}<br>${s2}<br>${s3}<br>${s4}<br>${s5}<br>${s6}<br>${s7}<br>${s8}<br>${s9}` ;
            localStorage.removeItem("User_Msg");
            localStorage.setItem("User_Msg",v);
        };


      // get message
      var message = localStorage.getItem("User_Msg");

      // save in database
      firebase.database().ref("Messages : Jan : 23 :").push().set({
        "sender": myName,
        "message": message,
        "date": Math.round(+new Date()/1000)
      });
      document.getElementById("message").value = "";
      window.scrollTo(0,document.body.scrollHeight);
      // prevent form from submitting
      return false;
     
    }

    // listen for incoming messages
	firebase.database().ref("Messages : Jan : 23 :").on("child_added", function (snapshot) {

		// give each message a unique ID

		// show delete button if message is sent by me
		if (snapshot.val().sender == myName) {

            var res = document.getElementById('dIv');
            

            function timeAgo(date_time){

              var current_time = Math.round(+new Date()/1000);
              // console.log(current_time);

              var date_time  = snapshot.val().date;
              // console.log(date_time);

              var msg_send_time = date_time;
              // var send = 1674574899
              // var msg_send_time = Math.round(send);
              // console.log(msg_send_time);

              var  different = current_time-msg_send_time;
              // console.log( different);

              if( different<2 && different==0){
                res.innerText= "A Few Sec Ago";
              }
              else if( different>2 && different<59){
                res.innerText= different+" Sec Ago";
              }
              else if( different>59 &&  different<120){
                res.innerText='One Min Ago';
              }
              else if( different>=121 &&  different<=3600){
                res.innerText= parseInt( different/60).toString()+" Min's Ago";
              }
              else if( different>3600 &&  different<7200){
                res.innerText='One Hour Ago';
              }
              else if( different>7200 &&  different<86400){
                res.innerText= parseInt( different/3600).toString()+" Hour's Ago";
              }
              else if( different>86400 &&  different<172800){
                res.innerText='1 Day Ago';
              }
              else if( different>172800 &&  different<604800){
                res.innerText= parseInt( different/86400).toString()+" Day's Ago";
              }
              else if( different>604800 &&  different<1209600){
                res.innerText= ' One Week Ago';
              }
              else if( different>1209600 &&  different<2630880){
                res.innerText= parseInt( different/604800).toString()+" Week's Ago";
              }
              else if( different>2630880 &&  different<5261760){
                res.innerText= '1 Month Ago';
              }
              else if( different>5261760 &&  different<31570560){
                res.innerText= parseInt( different/2630880).toString()+" Month's Ago";
              }
              else if( different>31570560 &&  different<63141120){
                res.innerText= '1 Year Ago';
              }
              else{
                res.innerText= parseInt( different/31570560).toString()+" Year's Ago";
              }
            };
            timeAgo();

            var msguser = `<article class="msg-container msg-self" id="msg-0">
                <div class="msg-box">
                <div class="flr">
                    <div class="messages">
                    <p class="msg" id="message1-${snapshot.key}">${snapshot.val().message}</p>
                    </div>
                    <span class="timestamp"><span class="username"><span><img class="user-img" src="${localStorage.getItem("User_Photo")}" alt="" srcset=""></span><b>${snapshot.val().sender}</b></span>&bull;<span class="posttime"><b>${document.getElementById('dIv').innerText}</b></span></span>
                    <span class="timestamp"><span class="username"><button class="bTn-self" data-id="${snapshot.key}" onclick='deleteMessage(this);'>Delete</button></span></span>
                </div>
                </div>
            </article>`

            document.getElementById("msgBox").innerHTML += msguser;
            window.scrollTo(0,document.body.scrollHeight);

		}else{



      var res = document.getElementById('dIv');
            

            function timeAgo(date_time){

              var current_time = Math.round(+new Date()/1000);
              // console.log(current_time);

              var date_time  = snapshot.val().date;
              // console.log(date_time);

              var msg_send_time = date_time;
              // var send = 1674574899
              // var msg_send_time = Math.round(send);
              // console.log(msg_send_time);

              var  different = current_time-msg_send_time;
              // console.log( different);

              if( different<2 && different==0){
                res.innerText= "A Few Sec Ago";
              }
              else if( different>2 && different<59){
                res.innerText= different+" Sec Ago";
              }
              else if( different>59 &&  different<120){
                res.innerText='One Min Ago';
              }
              else if( different>=121 &&  different<=3600){
                res.innerText= parseInt( different/60).toString()+" Min's Ago";
              }
              else if( different>3600 &&  different<7200){
                res.innerText='One Hour Ago';
              }
              else if( different>7200 &&  different<86400){
                res.innerText= parseInt( different/3600).toString()+" Hour's Ago";
              }
              else if( different>86400 &&  different<172800){
                res.innerText='1 Day Ago';
              }
              else if( different>172800 &&  different<604800){
                res.innerText= parseInt( different/86400).toString()+" Day's Ago";
              }
              else if( different>604800 &&  different<1209600){
                res.innerText= ' One Week Ago';
              }
              else if( different>1209600 &&  different<2630880){
                res.innerText= parseInt( different/604800).toString()+" Week's Ago";
              }
              else if( different>2630880 &&  different<5261760){
                res.innerText= '1 Month Ago';
              }
              else if( different>5261760 &&  different<31570560){
                res.innerText= parseInt( different/2630880).toString()+" Month's Ago";
              }
              else if( different>31570560 &&  different<63141120){
                res.innerText= '1 Year Ago';
              }
              else{
                res.innerText= parseInt( different/31570560).toString()+" Year's Ago";
              }
            };
            timeAgo();
            var msg = `<article class="msg-container msg-remote" id="msg-0">
                <div class="msg-box">
                <div class="flr">
                    <div class="messages">
                    <p class="msg" id="message1-${snapshot.key}">${snapshot.val().message}</p>
                    </div>
                    <span class="timestamp"><span class="username">${snapshot.val().sender}</span>&bull;<span class="posttime">${document.getElementById('dIv').innerText}</b></span></span></span></span>
                </div>
                </div>
            </article>`

            document.getElementById("msgBox").innerHTML += msg;
            window.scrollTo(0,document.body.scrollHeight);
        };

	});
    function deleteMessage(self) {
	// get message ID
	var messageId = self.getAttribute("data-id");

	// delete message
	firebase.database().ref("Messages : Jan : 23 :").child(messageId).remove();

    }

    //attach listener for delete message
    firebase.database().ref("Messages : Jan : 23 :").on("child_removed", function (snapshot) {
        // remove message node
        document.getElementById("message1-" + snapshot.key).innerHTML = "This message has been removed";
    });
    </script>
</head>
<body>
  <div id="dIv" style="display: none;"></div>
    <!-- create a form to send message -->

<section class="chatbox">
<section class="chat-window" id="msgBox">

  <!-- <article class="msg-container msg-self" id="msg-0">
    <div class="msg-box">
      <div class="flr">
        <div class="messages">
          <p class="msg" id="msg-1">This is 2</p>
        </div>
        <span class="timestamp"><span class="username"><span><img class="user-img" src="aa.JPG" alt="" srcset=""></span><b>Name</b></span>&bull;<span class="posttime"><b>2 minutes ago</b></span></span>
        <span class="timestamp"><span class="username"><button class="bTn-self" data-id='" + snapshot.key + "' onclick='deleteMessage(this);'>Delete</button></span></span>
      </div>
    </div>
  </article> -->

</section>
<form class="chat-input" onsubmit="return sendMessage()">
  <input id="message" placeholder="Enter message" autocomplete="off">
  <button> Send </button>
  
</form>
</section>
</body>
</html>